---
title: "BOUKHALFA"
author: "MÃ©lina Boukhalfa"
format: html
---
#Introduction
## Study organisation
###  Question 1 

```{r}
library(here)
library(vroom)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(knitr)
```

```{r}
here::i_am("grades-lab.Rproj")
```

```{r}
course_description<-vroom(here("data","courses.csv"))
```

### Question 2
```{r}
course_description|>
  rename("identifier"=course_id,
         "number of exams"=nb_grades)|>
  arrange(course) |>knitr::kable()
```
## Students 
### Question 3

```{r}
students<-vroom(here("data","students.csv"), col_types = cols(
                       birth_date=col_date()))
```
The {r}

## Grades 
### Question 4

```{r}
grades<-read.csv(here("data","grades.csv"))
grades<-read.csv("data/grades.csv", na.strings = "_")
grades<-vroom(here("data","grades.csv"),delim=":")
```

# Student population analysis
## Question 5 

```{r}
ggplot(students,aes(x=factor(group))) +
         geom_bar(position = "dodge")+
         theme_bw()
```
## Question 6
```{r}
ggplot(students,aes(x=factor(group), fill=sex)) +
         geom_bar(position="fill")+
         theme_bw()
```

## Question 7 
```{r}
age_students <- students|>
  mutate(
    age = as.numeric(format(Sys.Date(), "%Y")) - as.numeric(format(birth_date, "%Y")))
```

```{r}
ggplot(age_students,aes(x=age))+
  geom_density(bw="sj")+theme_minimal()
```

## Question 8 
```{r}
age_students|>group_by(group)|>summarise(median=median(age))|>
  knitr::kable()
```

## Question 9 

```{r}
age_students|> group_by(group)|>
  slice_max(age)|> 
  arrange(desc(age))|>
  summarise(identifier=id, sex=sex,age=age)|>
  knitr::kable()
```
# Simple grade analysis
## Question 10 

The data set contains `r sum(!is.na(course_description$nb_grades))` grades.

## Question 11

```{r}
grades |>
  filter(course_id == course_description |>
           filter(course == "Astrology and Celestial Navigation") |> 
           pull(course_id)) %>%
  left_join(students, by = "id") |>
  mutate(grade = as.numeric(grade)) |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE)) |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "steelblue") +
  theme_minimal()
```

## Question 12

```{r}
grades |>
  mutate(grade = as.numeric(grade))|> 
  filter(!is.na(grade))|>
  left_join(course_description, by = "course_id") |>
  ggplot(aes(x = factor(semester), y = grade, fill = factor(semester))) +
    geom_boxplot()
```

# Attendance analysis
## Question 13

```{r}
grades_per_student<-grades|> group_by(id)|>
  summarise(nb_grades=n())|>
  left_join(students, by="id")|>
  select(id,group,sex,nb_grades)
```

```{r}
grades_per_student|>slice_head(n=10)|>knitr::kable()
```


## Question 14 

```{r}
ggplot(grades_per_student,aes(x=sex,y=nb_grades,fill=sex))+
  geom_violin()
```

## Question 15
```{r}
pyramid_students<-course_description|>filter(course=="Pyramid Construction and Engineering")|>pull(course_id)

grades_pyramids<-grades|>filter(course_id == pyramid_students) |>
  group_by(id) |>
  summarise(nb_grades = n()) |>
  left_join(students, by = "id") |>
  select(id, group, nb_grades)

grades_pyramids|>slice_sample(n=10)|>knitr::kable()
```

## Question 16

```{r}
dist_pyramid<-grades_pyramids|>group_by(nb_grades)|>
  summarise(nb_students=n())|>
  arrange(nb_grades)

dist_pyramid|>knitr::kable()
dist_pyramid|>ggplot(aes(x=factor(nb_grades),y=nb_students))+
  geom_col()
```

## Question 17 
```{r}
grades_pyramids |>
  ggplot(aes(x = factor(group), y = nb_grades, fill = factor(group))) +
  geom_violin()
```

## Question 18
```{r}
grades_pyramids2<-grades|>filter(course_id == pyramid_students) |>
  group_by(id) |>
  summarise(nb_grades = n()) |>
  left_join(students, by = "id") |>
  select(id, group, nb_grades,sex)

ggplot(grades_pyramids2,aes(x=factor(group),y=nb_grades,fill=factor(group)))+
  geom_boxplot(width=0.6)+
  facet_wrap(vars(sex))
```

# Grade analysis
## Question 19 

```{r}
grades_summary <- grades |>
  mutate(grade = as.numeric(grade)) |>
  group_by(id, course_id) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE), .groups = "drop") |>
  left_join(students |> select(id, group), by = "id") |>
  left_join(course_description |> select(course_id, course), by = "course_id") |>
  select(id, group, course, avg_grade) |>
  pivot_wider(names_from = course, values_from = avg_grade)

grades_summary |>
  select(id, group, 
         `Alchemy and Hermetic Philosophy`, 
         `Astrology and Celestial Navigation`)|>
  slice_head(n = 10) |>
  knitr::kable(digits=2)
```

## Question 20

```{r}
grades_summary|>ggplot(aes(x = `Pharaonic Law and Governance`,
    y = `Medicine and Herbalism` )) +
  geom_point(alpha=0.5, color="lightblue")
```
There is no clear pattern, they seem a bit dependant from one another but not completely. 

## Question 21
```{r}
grades_summary|>group_by(group)|>summarise(correlation=cor(`Pharaonic Law and Governance`,`Alchemy and Hermetic Philosophy`))|>
  slice_head(n=10)|>knitr::kable()
```

There is a low correlation between the two courses, but they all seem positive. 

## Question 22

```{r}
top_group <- grades_summary |>
  group_by(group) |>
  summarise(cor_val = cor(
    `Pharaonic Law and Governance`,
    `Alchemy and Hermetic Philosophy`,
  ), .groups = "drop") |>
  slice_max(abs(cor_val)) |>
  pull(group)

grades_summary |>
  filter(group == top_group) |>
  ggplot(aes(
    x = `Alchemy and Hermetic Philosophy`,
    y = `Pharaonic Law and Governance`
  )) +
  geom_point(alpha=0.5) +
  theme_minimal()
```

There is no clear pattern. 

## Question 23

```{r}
final_grades <- grades_summary |>
  left_join(students |> select(id, sex), by = "id")|>
  mutate(final_grade = rowMeans(grades_wide[ , !(names(grades_wide) %in% c("id","group"))], na.rm = TRUE)) |>
  ungroup() |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))

final_grades |>
  slice_head(n=10) |>
  knitr::kable()
```

## Question 24 

```{r}
final_grades |>
  ggplot(aes(x = factor(group), y = final_grade)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7)
```

We see a slight dependency in some groups like 11. 

## Question 25

```{r}
final_grades |>
  ggplot(aes(x = factor(group), y = final_grade)) +
           facet_wrap(vars(sex))+
           geom_boxplot(fill = "steelblue", alpha = 0.7)
```
Female overall have better grades then male. 

## Question 26

```{r}
pass_info <- grades |>
  mutate(grade = as.numeric(grade)) |>
  left_join(course_description |> select(course_id, semester), by = "course_id") |>
  group_by(id, course_id, semester) |>
  summarise(avg_course = mean(grade, na.rm = TRUE), .groups = "drop") |>
  group_by(id) |>
  summarise(
    min_course = min(avg_course),
    min_semester = min(tapply(avg_course, semester, mean)),
    .groups = "drop"
  ) |>
  left_join(final_grades |> select(id, group, final_grade), by = "id") |>
  mutate(pass = (min_course >= 5) & (min_semester >= 10)) |>
  select(id, group, final_grade, pass)

pass_info |> slice_head(n = 10)|>knitr::kable()

```

## Question 27 

```{r}
fail_but_10<-pass_info |>
  filter(final_grade >= 10, pass == FALSE) |>
  summarise(n_students = n())

fail_but_10|> count()
```

## Question 28 
```{r}
pass_rate <- pass_info |>
  group_by(group) |>
  summarise(pass_rate = mean(pass) * 100, .groups = "drop")

pass_rate |> knitr::kable()

pass_rate |>
  ggplot(aes(x = factor(group), y = pass_rate)) +
  geom_col(fill = "steelblue")
```

## Question 29 
```{r}
course_failure <- grades |>
  mutate(grade = as.numeric(grade)) |>
  group_by(id, course_id) |>
  summarise(avg_course = mean(grade, na.rm = TRUE), .groups = "drop") |>
  filter(avg_course < 5) |>
  count(course_id, sort = TRUE) |>
  left_join(course_description |> select(course_id, course), by = "course_id") |>
  select(course, n)

course_failure |> slice_max(n, n = 1)
```

## Question 30 



